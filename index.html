<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÆó„Å°„ÇÉ„ÇìÂ∞ÇÁî®ÔºÅÊº¢Â≠ó„Éû„Çπ„Çø„Éº„Éª„É©„É≥„ÉÄ„É†BGMÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; overflow: hidden; background: #f1f5f9; height: 100vh; touch-action: manipulation; }
        .stage-1 { background-color: #fff1f2; border-color: #fda4af; color: #e11d48; } 
        .stage-2 { background-color: #f0f9ff; border-color: #7dd3fc; color: #0284c7; } 
        .stage-3 { background-color: #f0fdf4; border-color: #86efac; color: #16a34a; } 
        .feedback-pop { animation: giant-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.5) forwards; }
        @keyframes giant-pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .btn-shadow { border-bottom: 6px solid #cbd5e1; }
        .btn-shadow:active { border-bottom: 0; transform: translateY(6px); }
        .target-kanji { color: #ef4444; font-weight: 900; text-decoration: underline; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ÂïèÈ°åÊñá„ÅÆË°åÈñì„ÇíÂ∫É„Åè */
        #q-text { line-height: 2.2; min-height: 8em; }
    </style>
</head>
<body class="flex flex-col">

    <header class="bg-indigo-700 text-white p-2 shadow-lg flex-none flex justify-between items-center px-4">
        <span class="font-black text-sm tracking-widest">üìñ ÂÆó„Å°„ÇÉ„Çì„ÉªÊº¢Â≠óÈÅìÂ†¥</span>
        <div class="flex gap-2">
            <button id="bgm-toggle" onclick="toggleBGM()" class="bg-indigo-500 w-10 h-10 rounded-full border border-indigo-400 text-xl shadow-inner flex items-center justify-center transition-all active:scale-90">
                üéµ
            </button>
            <button id="sound-toggle" onclick="toggleSound()" class="bg-indigo-500 w-10 h-10 rounded-full border border-indigo-400 text-xl shadow-inner flex items-center justify-center transition-all active:scale-90">
                üîä
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto w-full flex-grow flex flex-col overflow-hidden p-3 relative">
        <div id="menu-screen" class="flex flex-col h-full">
            <h1 class="text-3xl font-black text-indigo-700 mb-3 text-center">Êº¢Â≠ó„É°„ÉÄ„É´„Çí„ÅÇ„Å§„ÇÅ„Çã</h1>
            <div id="course-list" class="flex-grow space-y-4 overflow-y-auto no-scrollbar pb-6"></div>
        </div>

        <div id="quiz-screen" class="hidden flex-grow flex flex-col">
            <div class="bg-white rounded-[2.5rem] p-6 shadow-2xl border-2 border-indigo-50 flex-grow flex flex-col overflow-hidden relative">
                <div id="q-text" class="text-2xl font-black mb-6 text-slate-800 border-l-8 border-indigo-500 pl-4 py-1"></div>
                
                <div class="mb-4">
                    <button id="hint-btn" onclick="toggleHint()" class="bg-yellow-400 px-6 py-2 rounded-full text-yellow-900 font-black text-sm shadow active:scale-95 mb-3">üí° „Éí„É≥„Éà</button>
                    <div id="hint-text" class="hidden text-slate-700 text-lg font-bold bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-200"></div>
                </div>
                <div id="choices" class="grid grid-cols-1 gap-3 mt-auto mb-1"></div>
                
                <div id="feedback-overlay" class="hidden absolute inset-0 bg-white z-50 p-6 flex flex-col border-t-8 border-indigo-600">
                    <div class="flex flex-col items-center justify-center flex-none h-44 mb-10 relative">
                        <div id="feedback-mark" class="text-[200px] font-black feedback-pop leading-none absolute"></div>
                    </div>
                    <div id="explanation-box" class="flex-grow bg-slate-50 rounded-[2rem] p-5 border-2 border-slate-200 overflow-y-auto no-scrollbar">
                        <div class="text-indigo-900 font-black text-2xl mb-2 underline decoration-yellow-400 decoration-4">Ê≠£Ëß£Ôºö<span id="correct-ans-display"></span></div>
                        <div id="exp-text" class="text-slate-800 text-lg font-bold leading-relaxed mb-3"></div>
                        <div class="bg-white p-3 rounded-2xl shadow-inner border-l-8 border-indigo-400">
                            <div class="text-indigo-500 text-[10px] font-black mb-1">„Äê‰Ωø„ÅÑÊñπ„ÅÆ‰æã„Äë</div>
                            <div id="exp-example" class="text-indigo-900 text-xl font-black italic"></div>
                        </div>
                    </div>
                    <button id="next-btn" class="w-full bg-indigo-600 text-white py-4 rounded-3xl font-black text-3xl shadow-2xl btn-shadow mt-4">Ê¨°„Å∏ ‚ûî</button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden flex flex-col items-center justify-center space-y-8 bg-white absolute inset-0 z-50 p-6">
            <div id="result-medal" class="text-[150px] animate-bounce">ü•á</div>
            <h2 id="praise-msg" class="text-3xl font-black text-indigo-700 text-center"></h2>
            <div id="result-stat" class="text-xl font-bold text-slate-500 bg-slate-100 px-8 py-3 rounded-full"></div>
            <button onclick="goHome()" class="w-full bg-indigo-600 text-white py-6 rounded-[2.5rem] font-black shadow-2xl text-3xl btn-shadow transition">„É°„Éã„É•„Éº„Å∏</button>
        </div>
    </main>

    <audio id="bgm-audio" loop></audio>

    <script>
        // ÂÜôÁúü„Å´„ÅÇ„Å£„Åü„Éï„Ç°„Ç§„É´Âêç„ÅÆ„É™„Çπ„Éà
        const BGM_FILES = [
            "126_BPM142.mp3",
            "128_BPM124.mp3",
            "233_BPM163.mp3",
            "275_BPM120.mp3",
            "416_BPM128.mp3",
            "447_BPM100.mp3"
        ];

        let isSoundOn = true;
        let isBGMOn = false;
        let audioCtx = null;
        const bgm = document.getElementById('bgm-audio');
        bgm.volume = 0.05; // Èü≥Ê•Ω„ÅÆÈü≥Èáè„ÅØÊéß„Åà„ÇÅ

        const STAGES = [
            { name: "Á¨¨Ôºë„Çπ„ÉÜ„Éº„Ç∏", class: "stage-1", questions: [
                {q: "Áí∞Â¢ÉÁ†¥Â£ä„ÅåÈÄ≤„Åø„ÄÅÁæé„Åó„ÅÑÊµ∑„ÅåÊ±ö„Çå„Å¶„ÅÑ„Çã„ÄÇÂ§ö„Åè„ÅÆ‰∫∫„ÅåÂ∞ÜÊù•„Å∏„ÅÆ„Äå„Ç≠„Ç∞„Äç„ÇíÂè£„Å´„Åó„Å¶„ÅÑ„Çã„ÄÇ", a: "Âç±ÊÉß", dummy: ["Â∏åÊ±Ç", "Ê©üÂÖ∑", "Âç±ÂÖ∑"], m: "ÊÇ™„ÅÑ„Åì„Å®„ÅåËµ∑„Åì„Çã„Åã„ÇÇ„ÄÅ„Å®ÂøÉÈÖç„Åó„Å¶ÊÅê„Çå„Çã„Åì„Å®„ÄÇ", ex: "Áµ∂ÊªÖ„ÅÆ{Âç±ÊÉß}„Åå„ÅÇ„ÇãÂãïÁâ©„Çí„Åø„Çì„Å™„Åß‰øùË≠∑„Åô„Çã„ÄÇ"},
                {q: "È´ò„ÅÑÂ±ïÊúõÂè∞„Å´Áôª„Çã„Å®„ÄÅË°ó‰∏¶„Åø„Åå‰∏ÄÊúõ„Åß„Åç„Çã„ÄÇ‰∏ä„Åã„ÇâÂÖ®‰Ωì„Çí„Äå„Éï„Ç´„É≥„Äç„Åô„Çã„ÅÆ„ÅØÊ∞óÊåÅ„Å°„Åå„ÅÑ„ÅÑ„ÄÇ", a: "‰øØÁû∞", dummy: ["‰∏çÊÑü", "ÊôÆÂãß", "Ë≤†Â∑ª"], m: "È´ò„ÅÑÊâÄ„Åã„ÇâÂÖ®‰Ωì„ÇíË¶ã‰∏ã„Çç„Åô„Åì„Å®„ÄÇ", ex: "Á©∫„ÇíÈ£õ„Å∂È≥•„ÅÆ„Çà„ÅÜ„Å´Ë°ó„Çí{‰øØÁû∞}„Åô„Çã„ÄÇ"},
                {q: "Â§±Êïó„ÇíÊÅê„Çå„Åö„Å´ÊåëÊà¶„ÅóÁ∂ö„Åë„Çã„Åì„Å®„ÅåÂ§ßÂàá„Å†„ÄÇ„Åù„ÅÆÁµåÈ®ì„Å´„ÅØ„ÄÅ‰∫∫Áîü„ÇíÂ§â„Åà„ÇãÂ§ß„Åç„Å™„Äå„Ç§„ÇÆ„Äç„Åå„ÅÇ„Çã„ÄÇ", a: "ÊÑèÁæ©", dummy: ["Áï∞Ë≠∞", "Â®ÅÂÑÄ", "ÊÑèÊäÄ"], m: "Áâ©‰∫ã„ÅÆ‰æ°ÂÄ§„ÇÑ„ÄÅ„ÇÑ„Çã„Åπ„ÅçÁêÜÁî±„ÅÆ„Åì„Å®„ÄÇ", ex: "„Åì„ÅÆÂãâÂº∑„Å´„ÅØ„ÄÅÂ∞ÜÊù•„Åç„Å£„Å®Â§ß„Åç„Å™{ÊÑèÁæ©}„Åå„ÅÇ„Çã„ÇàÔºÅ"},
                {q: "ÂΩº„ÅÆË™¨Êòé„ÅØÂÖ∑‰Ωì‰æã„Åå„Å™„Åè„Å¶ÂàÜ„Åã„Çä„Å´„Åè„ÅÑ„ÄÇ„ÇÇ„Å£„Å®„Äå„ÉÅ„É•„Ç¶„Ç∑„Éß„Ç¶„ÄçÁöÑ„Å™Ë©±„Åß„ÅØ„Å™„Åè„ÄÅÂÆü‰æã„Åå„Åª„Åó„ÅÑ„ÄÇ", a: "ÊäΩË±°", dummy: ["‰∏≠ÂÇ∑", "Ê≥®Âî±", "ÂÆôË±°"], m: "ÂΩ¢„ÅÆ„Å™„ÅÑ„ÄÅÈ†≠„ÅÆ‰∏≠„ÅÆÂÖ±ÈÄö„Åó„Åü„Ç§„É°„Éº„Ç∏„ÅÆ„Åì„Å®„ÄÇ", ex: "ÂÖ∑‰ΩìÁöÑ„Å™ÂΩ¢„Åå„Å™„ÅÑ{ÊäΩË±°}ÁöÑ„Å™Ê¶ÇÂøµ„ÇíË™¨Êòé„Åô„Çã„ÅÆ„ÅØÈõ£„Åó„ÅÑ„ÄÇ"},
                {q: "Ë™†ÂÆü„Å´Áîü„Åç„Çã„Åì„Å®„ÅØ„ÄÅ„Å©„ÅÆÂõΩ„Åß„ÇÇÂ§ßÂàá„Å´„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ„Åù„Çå„ÅØ‰∫∫È°û„Å´„Å®„Å£„Å¶„Äå„Éï„Éò„É≥„ÄçÁöÑ„Å™‰æ°ÂÄ§Ë¶≥„Å†„ÄÇ", a: "ÊôÆÈÅç", dummy: ["‰∏çÂ§â", "‰∏çÂÅè", "Â∏ÉÁ∑®"], m: "„ÅÑ„Å§„Åß„ÇÇ„Å©„Åì„Åß„ÇÇ„ÄÅ„Å†„Çå„Å´„Åß„ÇÇÂΩì„Å¶„ÅØ„Åæ„Çã„Åì„Å®„ÄÇ", ex: "ÊôÇ‰ª£„ÅåÂ§â„Çè„Å£„Å¶„ÇÇ{ÊôÆÈÅç}ÁöÑ„Å™Âπ∏Á¶è„ÅÆÂΩ¢„ÅØÂ§â„Çè„Çâ„Å™„ÅÑ„ÄÇ"}
            ]},
            { name: "Á¨¨Ôºí„Çπ„ÉÜ„Éº„Ç∏", class: "stage-2", questions: [
                {q: "Ê±∫ÂãùÊà¶„ÅØ‰∏°„ÉÅ„Éº„É†„Å®„ÇÇ‰∏ÄÊ≠©„ÇÇË≠≤„Çâ„Å™„ÅÑÂ±ïÈñã„Å†„ÄÇÂÆüÂäõ„Åå„Äå„Ç≠„ÉÉ„Ç≥„Ç¶„Äç„Åó„Å¶„Åä„Çä„ÄÅÁõÆ„ÅåÈõ¢„Åõ„Å™„ÅÑ„ÄÇ", a: "ÊãÆÊäó", dummy: ["ÂêâÂêë", "ÁµêÂêë", "ÂàáÊÑü"], m: "Âäõ„ÅåÂêå„Åò„Åè„Çâ„ÅÑ„Åß„ÄÅÊøÄ„Åó„ÅèÁ´∂„ÇäÂêà„Å£„Å¶„ÅÑ„Çã„Åì„Å®„ÄÇ", ex: "„É©„Ç§„Éê„É´ÂêåÂ£´„ÅÆÂÆüÂäõ„Åå{ÊãÆÊäó}„Åó„Å¶„ÅÑ„ÇãÂ•Ω„Ç≤„Éº„É†„Å†„ÄÇ"},
                {q: "Âë®„Çä„ÅÆ„Ç¢„Éâ„Éê„Ç§„Çπ„Å´ËÄ≥„ÇíÂÇæ„Åë„Çã„Åì„Å®„ÇÇÂøÖË¶Å„Å†„ÄÇËá™ÂàÜ„ÅÆËÄÉ„Åà„Å´„Äå„Ç≥„Ç∑„ÉÑ„Äç„Åó„Åô„Åé„Çã„Å®„ÄÅÊàêÈï∑„ÅåÊ≠¢„Åæ„Çã„ÄÇ", a: "Âõ∫Âü∑", dummy: ["ÂÄãÂü∑", "ÊπñÂü∑", "Âõ∫ÂÆ§"], m: "Ëá™ÂàÜ„ÅÆÊÑèË¶ã„ÇíÁµ∂ÂØæ„Å´Â§â„Åà„Çà„ÅÜ„Å®„Åó„Å™„ÅÑ„Åì„Å®„ÄÇ", ex: "Âè§„ÅÑ„ÇÑ„ÇäÊñπ„Å´{Âõ∫Âü∑}„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑ„ÉÅ„É£„É≥„Çπ„ÇíÈÄÉ„Åô„ÄÇ"},
                {q: "„Åì„ÅÆÁµµÁîª„ÅØÊòé„Çã„ÅÑËâ≤„Å®Êöó„ÅÑËâ≤„Åå‰Ωø„ÅÑÂàÜ„Åë„Çâ„Çå„Å¶„ÅÑ„Çã„ÄÇ‰∫å„Å§„ÅÆËâ≤„Åå„Äå„Çø„Ç§„Ç∑„Éß„Ç¶„ÄçÁöÑ„Åß„ÄÅËø´Âäõ„Åå„ÅÇ„Çã„ÄÇ", a: "ÂØæÁÖß", dummy: ["ÂØæË±°", "ÂØæÂãù", "‰ΩìË±°"], m: "‰∫å„Å§„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Å°„Åå„ÅÑ„Åå„ÅØ„Å£„Åç„Çä„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÄÇ", ex: "Èùô„Åã„Å™ÂÖÑ„Å®ÂÖÉÊ∞ó„Å™Âºü„ÅØ„ÄÅ„Å®„Å¶„ÇÇ{ÂØæÁÖß}ÁöÑ„Å™ÊÄßÊ†º„Å†„ÄÇ"},
                {q: "Èï∑„ÅÑÂπ¥Êúà„Çí„Åã„Åë„Å¶Á£®„Åã„Çå„ÅüËÅ∑‰∫∫„ÅÆÊäÄ„Åå„ÅÇ„Çã„ÄÇ„Åì„ÅÆÁ¥†Êô¥„Çâ„Åó„ÅÑ‰ºùÁµ±„ÇíÊ¨°„ÅÆ‰∏ñ‰ª£„Å∏„Äå„Ç±„Ç§„Ç∑„Éß„Ç¶„Äç„Åó„Åü„ÅÑ„ÄÇ", a: "Á∂ôÊâø", dummy: ["ÂΩ¢Âãù", "Êï¨Áß∞", "Á≥ªÂî±"], m: "Â§ßÂàá„Å™„ÇÇ„ÅÆ„ÇíÂâç„ÅÆ‰∫∫„Åã„ÇâÂèó„ÅëÁ∂ô„Åê„Åì„Å®„ÄÇ", ex: "Áà∂„Åã„ÇâÂèó„ÅëÁ∂ô„ÅÑ„Å†Â§ßÂàá„Å™ÈÅìÂÖ∑„Çí{Á∂ôÊâø}„Åó„Å¶„ÅÑ„Åè„ÄÇ"},
                {q: "‰ªäÊúü„ÅÆÂΩº„ÅÆÊ¥ªË∫ç„ÅØ„ÄÅË™∞„ÅÆÁõÆ„Åã„ÇâË¶ã„Å¶„ÇÇÊòé„Çâ„Åã„Å†„ÄÇÁâπ„Å´Âä™Âäõ„ÅÆÂßøÂã¢„ÅØ„Äå„Éà„ÇØ„Éí„ÉÑ„Äç„Åô„Åπ„ÅçÁÇπ„Åß„ÅÇ„Çã„ÄÇ", a: "ÁâπÁ≠Ü", dummy: ["ÂæóÁ≠Ü", "ÁâπÂøÖ", "ÁâπÁßò"], m: "ÁâπÂà•„Å´Êõ∏„Åè„Åª„Å©„ÄÅÁõÆÁ´ã„Å£„Å¶„ÅÑ„Çã„Åì„Å®„ÄÇ", ex: "ÂÆó„Å°„ÇÉ„Çì„ÅÆÊØéÊó•„ÅÆÈ†ëÂºµ„Çä„ÅØ{ÁâπÁ≠Ü}„Åô„Åπ„ÅçÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åì„Å®„Å†ÔºÅ"}
            ]},
            { name: "Á¨¨Ôºì„Çπ„ÉÜ„Éº„Ç∏", class: "stage-3", questions: [
                {q: "„ÉÜ„Çπ„Éà„ÅÆÁµêÊûú„ÅåÊÉ≥ÂÉè‰ª•‰∏ä„Å´ÊÇ™„Åè„Å¶ËêΩ„Å°Ëæº„Çì„Å†„ÄÇ„ÅÇ„Åæ„Çä„ÅÆÁÇπÊï∞„Å´„Äå„Ç¨„ÇØ„Çº„É≥„Äç„Å®„Åó„Å¶Ë®ÄËëâ„ÅåÂá∫„Å™„ÅÑ„ÄÇ", a: "ÊÑïÁÑ∂", dummy: ["Â≠¶ÁÑ∂", "Ê•ΩÁÑ∂", "Ë¶öÁÑ∂"], m: "‰∫àÊÉ≥Â§ñ„ÅÆÂá∫Êù•‰∫ã„Å´„ÄÅ„Å≤„Å©„ÅèÈ©ö„Åè„Åì„Å®„ÄÇ", ex: "‰ø°„Åò„Å¶„ÅÑ„ÅüË®àÁîª„ÅåÂ§±Êïó„Åó„ÄÅ{ÊÑïÁÑ∂}„Å®„Åó„Å¶Á´ã„Å°Â∞Ω„Åè„Åô„ÄÇ"},
                {q: "ÊóÖÂÖà„ÅßË¶ã„Å§„Åë„ÅüÊπñ„ÅØ„ÄÅÈè°„ÅÆ„Çà„ÅÜ„Å´ÈÄè„ÅçÈÄö„Å£„Å¶„ÅÑ„Åü„ÄÇ„ÅÇ„Åæ„Çä„ÅÆÁæé„Åó„Åï„Å´„Äå„Éú„Ç¶„Çº„É≥„Äç„Å®Ë¶ãÊÉö„Çå„Å¶„Åó„Åæ„Å£„Åü„ÄÇ", a: "Ëå´ÁÑ∂", dummy: ["ÂÜíÁÑ∂", "Êö¥ÁÑ∂", "Èò≤ÁÑ∂"], m: "È©ö„Åç„ÇÑÊÑüÂãï„Åß„ÄÅÈ†≠„ÅåÁúü„Å£ÁôΩ„Å´„Å™„Å£„Å¶„Åº„Éº„Å£„Å®„Åô„Çã„Åì„Å®„ÄÇ", ex: "„ÅÇ„Åæ„Çä„ÅÆÁµ∂ÊôØ„Å´{Ëå´ÁÑ∂}„Å®„Åó„Å¶„Åó„Åæ„ÅÑ„ÄÅÊôÇÈñì„ÇíÂøò„Çå„Åü„ÄÇ"},
                {q: "‰ºöË≠∞„ÅÆÊôÇÈñì„ÅØÈôê„Çâ„Çå„Å¶„ÅÑ„Çã„ÅÆ„ÅßÊÄ•„ÅÑ„Åß„Åª„Åó„ÅÑ„ÄÇÂ†±Âëä„ÅØË¶ÅÁÇπ„Çí„Åæ„Å®„ÇÅ„Å¶„Äå„Ç´„É≥„Ç±„ÉÑ„Äç„Å´‰ºù„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", a: "Á∞°ÊΩî", dummy: ["ÂÆåÁµê", "ÊÑüË°Ä", "Ë¶≥ÂÇë"], m: "Áü≠„Åè„Å¶„ÄÅÂÜÖÂÆπ„ÅåÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ„Åì„Å®„ÄÇ", ex: "Â§ß‰∫ã„Å™„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ{Á∞°ÊΩî}„Å´Êõ∏„Åè„Åª„ÅÜ„Åå‰ºù„Çè„Çä„ÇÑ„Åô„ÅÑ„ÄÇ"},
                {q: "ÂΩº„ÅØËá™ÂàÜ„ÅÆÊàêÂäü„ÇíÈºª„Å´„Åã„Åë„Å¶Â®ÅÂºµ„Å£„Å¶„ÅÑ„Çã„ÄÇËá™ÂàÜ„ÅÆÊâçËÉΩ„Çí„Äå„Ç≥„Ç∏„Äç„Åô„Çã„Çà„ÅÜ„Å™ÊÖãÂ∫¶„ÅØÊÑüÂøÉ„Åó„Å™„ÅÑ„ÄÇ", a: "Ë™áÁ§∫", dummy: ["Âõ∫Ëæû", "Â≠§ÂÖê", "Â∫´Á§∫"], m: "Ëá™ÂàÜ„ÅÆÂæóÊÑè„Å™„Åì„Å®„Çí„ÄÅË¶ã„Åõ„Å§„Åë„Çã„Åì„Å®„ÄÇ", ex: "Ëá™ÂàÜ„ÅÆÂº∑„Åï„ÇíÂë®Âõ≤„Å´{Ë™áÁ§∫}„Åô„Çã„Çà„ÅÜ„Å™ÊåØ„ÇãËàû„ÅÑ„ÄÇ"},
                {q: "„Åø„Çì„Å™„ÅÆÊúüÂæÖ„Å´Âøú„Åà„Çâ„Çå„Çã„Çà„ÅÜ„Å´Ê∫ñÂÇô„Åó„Å¶„Åç„Åü„ÄÇ„Åù„ÅÆÊúüÂæÖ„Å´„Äå„ÇΩ„Äç„Åà„Çã„Çà„ÅÜ„ÄÅÂÖ®Âäõ„ÇíÂ∞Ω„Åè„Åô„Å§„ÇÇ„Çä„Å†„ÄÇ", a: "Ê∑ª", dummy: ["Ââä", "ÂâØ", "Áãô"], m: "ÁõÆÁöÑ„ÇÑÊúüÂæÖ„Å´„ÄÅ„Å¥„Å£„Åü„Çä„Å®Âêà„ÅÜ„Åì„Å®„ÄÇ", ex: "„ÅäÁà∂„Åï„Çì„ÅÆÊúüÂæÖ„Å´{Ê∑ª}„Åà„Çã„Çà„ÅÜ„ÄÅ‰∏ÄÁîüÊá∏ÂëΩ„Å´Á∑¥Áøí„Åô„Çã„ÄÇ"}
            ]}
        ];

        const Sound = {
            init() {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
            },
            playSE(freq, type, duration) {
                if (!isSoundOn) return;
                this.init();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.06, audioCtx.currentTime);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            ok() { this.playSE(880, 'sine', 0.1); setTimeout(() => this.playSE(1760, 'sine', 0.2), 100); },
            ng() { this.playSE(200, 'sawtooth', 0.4); }
        };

        function toggleBGM() {
            if (!isBGMOn) {
                // „É©„É≥„ÉÄ„É†„Å´Êõ≤„ÇíÈÅ∏„Å∂
                const randomFile = BGM_FILES[Math.floor(Math.random() * BGM_FILES.length)];
                bgm.src = randomFile;
                bgm.play();
                isBGMOn = true;
                document.getElementById('bgm-toggle').innerText = 'üéµ';
                document.getElementById('bgm-toggle').classList.remove('bg-slate-400');
                document.getElementById('bgm-toggle').classList.add('bg-indigo-500');
            } else {
                bgm.pause();
                isBGMOn = false;
                document.getElementById('bgm-toggle').innerText = '‚ùå';
                document.getElementById('bgm-toggle').classList.remove('bg-indigo-500');
                document.getElementById('bgm-toggle').classList.add('bg-slate-400');
            }
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            document.getElementById('sound-toggle').innerText = isSoundOn ? 'üîä' : 'üîá';
        }

        let userMedals = JSON.parse(localStorage.getItem('sou_medals_v22')) || {0:[], 1:[], 2:[]};
        let currentS = 0, qIdx = 0, correctCount = 0;

        function renderMenu() {
            const container = document.getElementById('course-list');
            container.innerHTML = '';
            STAGES.forEach((stage, i) => {
                const medalsHtml = userMedals[i].map(m => `<span class="inline-block animate-bounce mx-1 text-3xl drop-shadow">${m}</span>`).join('');
                container.innerHTML += `
                    <div class="rounded-[2rem] border-4 p-4 shadow-xl ${stage.class}">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-2xl font-black">${stage.name}</h2>
                            <div class="flex">${medalsHtml}</div>
                        </div>
                        <button onclick="startQuiz(${i})" class="w-full bg-white text-slate-800 font-black py-4 rounded-2xl shadow-md text-2xl hover:bg-slate-50 btn-shadow">„Çπ„Çø„Éº„Éà</button>
                    </div>`;
            });
        }

        function startQuiz(idx) {
            Sound.init();
            if (!isBGMOn) toggleBGM();
            currentS = idx; qIdx = 0; correctCount = 0;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            showQuestion();
        }

        function showQuestion() {
            const data = STAGES[currentS].questions[qIdx];
            const highlightedText = data.q.replace(/„Äå(.*?)„Äç/, '<span class="text-indigo-600 bg-yellow-200 px-1 rounded border-b-4 border-indigo-400">„Äå$1„Äç</span>');
            document.getElementById('q-text').innerHTML = highlightedText;
            document.getElementById('hint-text').innerText = data.m;
            document.getElementById('hint-text').classList.add('hidden');
            document.getElementById('feedback-overlay').classList.add('hidden');
            const choices = [data.a, ...data.dummy].sort(() => Math.random() - 0.5);
            const btnArea = document.getElementById('choices');
            btnArea.innerHTML = '';
            choices.forEach((c) => {
                const b = document.createElement('button');
                b.className = "w-full py-5 bg-white border-2 border-slate-200 rounded-2xl font-black text-4xl btn-shadow transition-all";
                b.innerText = c;
                b.onclick = () => check(c === data.a);
                btnArea.appendChild(b);
            });
        }

        function check(isCorrect) {
            const data = STAGES[currentS].questions[qIdx];
            const overlay = document.getElementById('feedback-overlay');
            const mark = document.getElementById('feedback-mark');
            overlay.classList.remove('hidden');
            document.getElementById('correct-ans-display').innerText = data.a;
            document.getElementById('exp-text').innerText = data.m;
            document.getElementById('exp-example').innerHTML = data.ex.replace('{', '<span class="target-kanji">').replace('}', '</span>');
            if(isCorrect) {
                correctCount++; Sound.ok();
                mark.innerText = "‚≠ï"; mark.style.color = "#ef4444";
            } else {
                Sound.ng();
                mark.innerText = "‚ùå"; mark.style.color = "#3b82f6";
            }
            document.getElementById('next-btn').onclick = () => {
                if(qIdx < STAGES[currentS].questions.length - 1) { qIdx++; showQuestion(); }
                else { finish(); }
            };
        }

        function finish() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            let medal = (correctCount === 5) ? "ü•á" : (correctCount === 4) ? "ü•à" : "";
            if(medal) {
                userMedals[currentS].push(medal);
                localStorage.setItem('sou_medals_v22', JSON.stringify(userMedals));
                document.getElementById('result-medal').innerText = medal;
                document.getElementById('praise-msg').innerText = "ÂÆó„Å°„ÇÉ„Çì„ÄÅ„Åô„Åî„ÅÑ„ÅûÔºÅ";
                confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
            } else {
                document.getElementById('result-medal').innerText = "üí™";
                document.getElementById('praise-msg').innerText = "È†ëÂºµ„Å£„Åü„Å≠ÔºÅ";
            }
            document.getElementById('result-stat').innerText = `5Âïè‰∏≠ ${correctCount}Âïè Ê≠£Ëß£ÔºÅ`;
        }

        function goHome() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            renderMenu();
        }

        function toggleHint() { document.getElementById('hint-text').classList.toggle('hidden'); }

        renderMenu();
    </script>
</body>
</html>
